<template>
  <b-container fluid>
    <div>
      <h2>
        Vulnerability Data
      </h2>
      <b-row>
        <b-col cols="12" lg="6">
          <Navbar />
          <div>
            <Description
              v-if="!isLoading"
              :descData="descData" />
            <div v-else class="d-flex justify-content-center align-items-center">
              <b-spinner class="m-5" label="Busy"></b-spinner>
            </div>
          </div>

        </b-col>
        <b-col cols="12" lg="6">
          <div v-if="!isLoading">
            <Chart :chartData="chartData" />
            <b-row>
              <b-col>
                <b-form-select v-model="selected" :options="options"></b-form-select>
              </b-col>
              <b-col>
                <b-form-group
                  id="input-group-1"
                  label="With score above: "
                  label-for="input-1"
                >
                  <b-form-input
                    id="input-1"
                    v-model.number="score"
                    type="number"
                    placeholder="enter number"
                  ></b-form-input>
                </b-form-group>
              </b-col>
            </b-row>

            <Table :tableData="tableData" />

          </div>
          <div v-else class="d-flex justify-content-center align-items-center">
            <b-spinner class="m-5" label="Busy"></b-spinner>
          </div>
        </b-col>
      </b-row>
    </div>

  </b-container>
</template>

<script>
// eslint-disable-next-line
import Chartist from 'chartist';
import Navbar from './navbar.vue';
import Description from './description.vue';
import Chart from './chart.vue';
import Table from './table.vue';

export default {
  components: {
    Navbar,
    Description,
    Chart,
    Table,
  },
  data() {
    return {
      isLoading: false,
      score: null,
      selected: 'all',
      options: [
        { value: 'all', text: 'Select all' },
        { value: 'important', text: 'Important' },
        { value: 'not_important', text: 'Not important' },
      ],
      descData: [],
      chartData: null,
      tableData: [],
      list: [],
    };
  },
  watch: {
    $route() {
      this.getData();
      this.resetData();
    },
    score(newVal, oldVal = []) {
      if (this.selected === 'all') {
        const newList = this.list.filter((data) => (data.score >= (typeof newVal === 'number' ? newVal : 0)));
        this.tableData = newList;
      } else if (newVal <= oldVal) {
        const newList = this.tableData.filter((data) => (data.score >= newVal));
        this.tableData = newList;
      } else {
        const newList = this.list.filter((data) => (data.score >= newVal && data.important === (this.selected === 'important')));
        this.tableData = newList;
      }
    },
    selected(newVal) {
      const currentScore = typeof this.score === 'number' ? this.score : 0;
      if (newVal === 'important') {
        const newList = this.list.filter((data) => (data.score >= currentScore && data.important === (newVal === 'important')));
        this.tableData = newList;
      } else if (newVal === 'not_important') {
        const newList = this.list.filter((data) => (data.score >= currentScore && data.important === (newVal === 'important')));
        this.tableData = newList;
      } else {
        const newList = this.list.filter((data) => (data.score >= currentScore));
        this.tableData = newList;
      }
    },
  },
  created() {
    this.getData();
  },
  methods: {
    resetData() {
      this.score = null;
      this.selected = 'all';
    },
    getData() {
      this.isLoading = true;
      fetch(`/chart/${this.$route.params.id}`)
        .then((response) => response.json())
        .then((data) => {
          const { bullets, chart, list } = data;
          this.descData = bullets;
          this.chartData = chart;
          this.tableData = list;
          this.list = list;
          this.isLoading = false;
        });
    },
  },

};
</script>

<style lang='scss' scoped>

</style>

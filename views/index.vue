<template>
  <b-container
    class="mb-5"
    fluid>
    <div>
      <h2 class="mt-4 mb-5">
        Vulnerability Data
      </h2>
      <b-row>
        <b-col
          v-if="!isMobile"
          cols="12"
          lg="6"
          :class="{ 'border-right' : !isMobile }">
          <Navbar :isMobile="isMobile"/>
          <div class="mt-3">
            <Description
              v-if="!isLoading"
              :descData="descData" />
            <div v-else class="d-flex justify-content-center align-items-center">
              <b-spinner class="m-5" label="Busy"></b-spinner>
            </div>
          </div>

        </b-col>
        <b-col cols="12" lg="6">
          <div v-if="!isLoading">
            <Chart :chartData="chartData" />

            <hr />

            <b-row>
              <b-col>
                <label for="input-select-1" class="zero-opacity">Label select</label>
                <b-form-select
                  id="input-select-1"
                  v-model="selected"
                  :options="options">
                </b-form-select>
              </b-col>
              <b-col>
                <b-form-group
                  id="input-group-1"
                  label="With score above: "
                  label-for="input-1"
                >
                  <b-form-input
                    id="input-1"
                    v-model.number="score"
                    type="number"
                    placeholder="Enter number"
                  ></b-form-input>
                </b-form-group>
              </b-col>
            </b-row>

            <Table
              :tableData="tableData"
              :isAscending="isAscending"
              @isAscending="sortDataAscending" />

          </div>
          <div v-else class="d-flex justify-content-center align-items-center">
            <b-spinner class="m-5" label="Busy"></b-spinner>
          </div>
        </b-col>
        <b-col
          v-if="isMobile"
          cols="12"
          lg="6"
          :class="{ 'border-right' : !isMobile }">
          <Navbar :isMobile="isMobile"/>
          <div class="mt-3">
            <Description
              v-if="!isLoading"
              :descData="descData" />
            <div v-else class="d-flex justify-content-center align-items-center">
              <b-spinner class="m-5" label="Busy"></b-spinner>
            </div>
          </div>

        </b-col>
      </b-row>
    </div>

  </b-container>
</template>

<script>
// eslint-disable-next-line
import Chartist from 'chartist';
import Navbar from './navbar.vue';
import Description from './description.vue';
import Chart from './chart.vue';
import Table from './table.vue';

const debounce = (func, delay) => {
  let inDebounce;
  // eslint-disable-next-line
  return function () {
    const context = this;
    // eslint-disable-next-line
    const args = arguments;
    clearTimeout(inDebounce);
    inDebounce = setTimeout(() => func.apply(context, args),
      delay);
  };
};

export default {
  components: {
    Navbar,
    Description,
    Chart,
    Table,
  },
  data() {
    return {
      isLoading: false,
      score: null,
      isMobile: false,
      selected: 'all',
      options: [
        { value: 'all', text: 'Select all' },
        { value: 'important', text: 'Show only important' },
        { value: 'not_important', text: 'Show only not important' },
      ],
      isAscending: null,
      descData: [],
      chartData: null,
      tableData: [],
      list: [],
    };
  },
  watch: {
    $route() {
      this.isLoading = true;
      this.getData();
    },
    score(newVal, oldVal = 0) {
      this.sortDataScore(newVal, oldVal);
    },
    selected(newVal) {
      this.sortDataSelect(newVal);
    },
  },
  created() {
    this.isLoading = true;
    this.getData();

    const w = window.innerWidth;
    if (w < 992) {
      this.isMobile = true;
    }
  },
  methods: {
    resetData() {
      this.score = null;
      this.selected = 'all';
    },
    sortDataSelect(newVal) {
      const currentScore = typeof this.score === 'number' ? this.score : 0;
      if (newVal === 'important') {
        const newList = this.list.filter((data) => (data.score >= currentScore && data.important === (newVal === 'important')));
        this.tableData = newList;
      } else if (newVal === 'not_important') {
        const newList = this.list.filter((data) => (data.score >= currentScore && data.important === (newVal === 'important')));
        this.tableData = newList;
      } else {
        const newList = this.list.filter((data) => (data.score >= currentScore));
        this.tableData = newList;
      }
    },
    sortDataScore(newVal, oldVal) {
      if (this.selected === 'all') {
        const newList = this.list.filter((data) => (data.score >= (typeof newVal === 'number' ? newVal : 0)));
        this.tableData = newList;
      } else if (newVal > oldVal) {
        const newList = this.tableData.filter((data) => (data.score >= newVal));
        this.tableData = newList;
      } else {
        const newList = this.list.filter((data) => (data.score >= newVal && data.important === (this.selected === 'important')));
        this.tableData = newList;
      }
    },
    sortDataAscending(isAscending) {
      this.isAscending = isAscending;
      // eslint-disable-next-line
      this.tableData = this.tableData.sort((a, b) => (isAscending ? (a.name > b.name ? -1 : 1) : (a.name < b.name ? -1 : 1)));
    },
    // eslint-disable-next-line
    getData: debounce(function () {
      fetch(`${process.env.REST_API}chart/${this.$route.params.id}`)
        .then((response) => response.json())
        .then((data) => {
          const { bullets, chart, list } = data;
          this.descData = bullets;
          this.chartData = chart;
          this.list = list;
          this.tableData = list;
          this.sortDataSelect(this.selected);
          this.isLoading = false;
          if (this.isAscending !== null) {
            this.sortDataAscending(this.isAscending);
          }
        });
    }, 200),
  },

};
</script>

<style lang='scss' scoped>
$grey: grey;

.border-right {
  border-right: 1px solid $grey;
}
.zero-opacity {
  opacity: 0;
}
</style>
